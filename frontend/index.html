<!--
  ============================================================================
  raiveFlier — Single Page Application (SPA)
  ============================================================================

  ARCHITECTURE OVERVIEW
  =====================
  This is a vanilla JS + HTML + CSS frontend for the raiveFlier application.
  The app analyzes rave/concert flier images using a FastAPI Python backend
  at /api/v1/*.

  SPA STRUCTURE — SECTION-BASED VIEW SWITCHING
  =============================================
  The app uses a section-based view pattern (not a router). All four views
  (upload, confirm, progress, results) exist as <section> elements inside
  <main id="app">. Only one section is visible at a time — the others have
  the HTML `hidden` attribute. View switching is managed by App.showView()
  in app.js, which toggles the `hidden` attribute on each section.

  USER FLOW
  =========
  1. UPLOAD VIEW   (#upload-view)   — User drops/selects a flier image
  2. CONFIRM VIEW  (#confirm-view)  — User reviews/edits OCR-extracted entities
  3. PROGRESS VIEW (#progress-view) — Real-time pipeline progress via WebSocket
  4. RESULTS VIEW  (#results-view)  — Full research results rendered as cards

  SUPPLEMENTARY PANELS (always available, overlaid)
  ==================================================
  - Corpus sidebar (#corpus-sidebar)  — Left slide-in RAG search panel
  - Q&A drawer     (#qa-drawer)       — Right slide-in follow-up questions
  - Recommendations (#reco-panel)     — Bottom-anchored artist recommendations

  MODULE LOADING ORDER
  ====================
  Scripts are loaded at the bottom of <body> in dependency order:
    app.js -> upload.js -> confirmation.js -> websocket.js -> corpus.js
    -> rating.js -> qa.js -> recommendations.js -> results.js
  Each module is an IIFE returning a public API object. They communicate
  via direct function calls (e.g., App.showView(), Confirmation.populateConfirmView()).

  KEY DOM ELEMENTS TARGETED BY JS MODULES
  ========================================
  - #drop-zone, #file-input, #submit-btn    — upload.js (drag-and-drop + submit)
  - #preview-area, #preview-image            — upload.js (image preview)
  - #duplicate-warning, #duplicate-*         — upload.js (duplicate detection UI)
  - #confirm-view                            — confirmation.js (dynamically populated)
  - #progress-view                           — websocket.js (dynamically populated)
  - #results-view                            — results.js (dynamically populated)
  - #corpus-sidebar, #corpus-toggle          — corpus.js (sidebar + toggle button)
  - #qa-drawer                               — qa.js (slide-in Q&A panel)
  - #reco-panel                              — recommendations.js (bottom panel)
  ============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- SEO description for the application -->
  <meta name="description" content="raiveFlier — Upload a rave flier, get deep research on every artist, venue, and promoter.">
  <!-- Theme color matches the dark bunker palette background (#0a0a0c) -->
  <meta name="theme-color" content="#0a0a0c">
  <title>raiveFlier</title>

  <!-- Favicon — multiple sizes for cross-device compatibility -->
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <!-- Google Fonts — Three typeface families used across the design system:
       - Space Grotesk: Display headings and titles (--font-display)
       - Inter: Body text and UI elements (--font-body)
       - IBM Plex Mono: Captions, badges, and technical text (--font-mono)
       Preconnect hints speed up the font download by establishing early connections -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Single stylesheet — contains the full design system including all component styles -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Film grain overlay — Purely decorative. Adds a subtle animated noise texture
       over the entire page to evoke the aesthetic of old rave fliers and photocopied
       zines. Uses an inline SVG data URI with feTurbulence for the noise pattern.
       aria-hidden="true" ensures screen readers skip this decorative element. -->
  <div class="grain-overlay" aria-hidden="true"></div>

  <!-- Site header — Static branding, visible on all views -->
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">raiveFlier</h1>
      <p class="site-subtitle">Upload a rave flier. Get the full story.</p>
    </div>
  </header>

  <!-- Corpus Search Sidebar — Fixed left-side panel for RAG knowledge base search.
       This <aside> is managed entirely by corpus.js, which injects the search input,
       filters, results list, and drag handle for resizing. The panel slides in/out
       via CSS transform (corpus-sidebar--open class). Always available regardless
       of which view is active — it operates independently of the analysis pipeline. -->
  <aside id="corpus-sidebar" class="corpus-sidebar" aria-label="Search knowledge base">
    <!-- Populated dynamically by corpus.js -->
  </aside>

  <!-- Corpus toggle button — Fixed to bottom-left of viewport.
       Clicking it calls Corpus.togglePanel() to open/close the sidebar.
       Hidden (display: none) when the sidebar is open. Dimmed when RAG
       is not available (no corpus data ingested). -->
  <button type="button" id="corpus-toggle" class="corpus-toggle" aria-label="Toggle corpus search" aria-expanded="false">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
      <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="corpus-toggle__label">Rave Knowledge</span>
  </button>

  <!-- Main content area — Contains all four SPA views as <section> elements.
       The #app container uses flex:1 to fill remaining viewport height.
       Only one child <section> is visible at a time (others have hidden attr). -->
  <main id="app" class="container">

    <!-- ===== VIEW 1: UPLOAD =====
         The initial view where the user selects a flier image.
         Managed by upload.js — handles drag-and-drop, file validation,
         image preview, duplicate detection, and POST to /api/v1/fliers/upload.
         On success, upload.js calls App.showView("confirm") to advance. -->
    <section id="upload-view" class="view" aria-label="Upload flier">
      <!-- Drop zone — Acts as both a drag target and a click target.
           role="button" + tabindex="0" make it keyboard-accessible.
           upload.js toggles the .drag-over class for visual feedback.
           Contains two mutually exclusive child divs:
             - .drop-zone__content: shown when no file is selected
             - .drop-zone__preview: shown after file selection (initially hidden) -->
      <div class="drop-zone" id="drop-zone" role="button" tabindex="0" aria-label="Drop a rave flier image here or click to browse">
        <div class="drop-zone__content">
          <svg class="drop-zone__icon" width="48" height="48" viewBox="0 0 48 48" fill="none" aria-hidden="true">
            <path d="M24 4L24 32M24 4L16 12M24 4L32 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 28V40C8 41.1 8.9 42 10 42H38C39.1 42 40 41.1 40 40V28" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="drop-zone__label">Drop rave flier here</p>
          <p class="drop-zone__hint">JPEG, PNG, or WEBP &middot; Max 10 MB</p>
        </div>
        <!-- Preview area — upload.js sets #preview-image.src via FileReader,
             then hides .drop-zone__content and unhides this div -->
        <div class="drop-zone__preview" id="preview-area" hidden>
          <img id="preview-image" alt="Flier preview" class="drop-zone__preview-img">
          <!-- Clear button — e.stopPropagation() prevents triggering the drop zone click -->
          <button type="button" class="btn-clear" id="clear-btn" aria-label="Remove selected file">&times;</button>
        </div>
      </div>

      <!-- Hidden file input — triggered programmatically by clicking the drop zone
           or the "browse files" label. The accept attribute restricts the file picker
           to supported image types. sr-only class visually hides it. -->
      <input type="file" id="file-input" class="sr-only" accept="image/jpeg,image/png,image/webp" aria-label="Choose a flier image">
      <label for="file-input" class="btn-secondary btn-browse">Or browse files</label>

      <!-- Submit button — Disabled until a valid file is selected.
           upload.js re-enables it after _handleFileSelect() validates the file. -->
      <div class="upload-actions">
        <button type="button" class="btn-primary" id="submit-btn" disabled>Analyze Flier</button>
      </div>

      <!-- Duplicate flier warning — Shown when the backend detects a perceptual hash
           match with a previously analyzed flier. upload.js populates the text and
           metadata tags dynamically. The user can choose "Analyze Anyway" to proceed
           or "Cancel" to reset. Uses role="alert" for screen reader announcements. -->
      <div class="duplicate-warning" id="duplicate-warning" role="alert" hidden>
        <div class="duplicate-warning__header">
          <svg class="duplicate-warning__icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="duplicate-warning__title">Possible duplicate detected</span>
        </div>
        <!-- Dynamically populated by upload.js with similarity %, date, and entity tags -->
        <p class="duplicate-warning__text" id="duplicate-warning-text"></p>
        <div class="duplicate-warning__meta" id="duplicate-warning-meta"></div>
        <div class="duplicate-warning__actions">
          <button type="button" class="btn-primary btn-sm" id="duplicate-analyze-btn">Analyze Anyway</button>
          <button type="button" class="btn-secondary btn-sm" id="duplicate-cancel-btn">Cancel</button>
        </div>
      </div>

      <!-- Error display — upload.js shows/hides this and sets its textContent -->
      <div class="upload-error" id="upload-error" role="alert" hidden></div>

      <!-- Full-screen loading overlay — Shown during the upload POST (OCR processing).
           Covers the viewport with a semi-transparent dark backdrop + spinner. -->
      <div class="loading-overlay" id="loading-overlay" hidden>
        <div class="spinner" aria-label="Processing"></div>
        <p class="loading-text">Running OCR&hellip;</p>
      </div>
    </section>

    <!-- ===== VIEW 2: CONFIRM ENTITIES =====
         The human-in-the-loop gate. confirmation.js dynamically builds editable
         entity cards (artists, venue, date, promoter, event name, genres, ticket
         price) from the upload response. The user can edit/add/remove entities
         before confirming. On confirm, POSTs to /api/v1/fliers/{session_id}/confirm
         and advances to the progress view. -->
    <section id="confirm-view" class="view" aria-label="Confirm extracted entities" hidden>
      <!-- Populated dynamically by confirmation.js -->
    </section>

    <!-- ===== VIEW 3: PIPELINE PROGRESS =====
         websocket.js builds a 5-phase pipeline visualization (OCR -> Entities ->
         Research -> Connections -> Output) with an animated progress bar.
         Connects to ws://.../ws/progress/{session_id} for real-time updates.
         When progress reaches 100%, auto-transitions to the results view. -->
    <section id="progress-view" class="view" aria-label="Pipeline progress" hidden>
      <!-- Populated dynamically by websocket.js -->
    </section>

    <!-- ===== VIEW 4: RESULTS =====
         The final view. results.js fetches from /api/v1/fliers/{session_id}/results,
         normalizes the API response, and renders multiple sections:
           - Event summary header (flier thumbnail + metadata tags)
           - Artist cards (expandable, with releases, labels, links)
           - Venue & promoter cards
           - Event history (past instances of the same event series)
           - Date & cultural context panels
           - Interconnections (narrative + relationship list + SVG graph)
           - Export JSON button
         Each section includes Q&A trigger buttons and rating widgets. -->
    <section id="results-view" class="view" aria-label="Analysis results" hidden>
      <!-- Dynamically populated by results.js -->
    </section>

  </main>

  <!-- Q&A Drawer — Right-side slide-in panel for interactive follow-up questions.
       qa.js renders the chat UI inside this <aside>. Opened via "Ask about this"
       buttons on result cards. Communicates with /api/v1/fliers/{session_id}/ask.
       Supports entity-scoped questions and clickable related-fact chips. -->
  <aside id="qa-drawer" class="qa-drawer" aria-label="Ask a question"></aside>

  <!-- Recommendations Panel — Bottom-anchored floating panel for artist discovery.
       recommendations.js renders a toggle bar + scrollable card list.
       Uses a two-phase fetch strategy: quick label-mates first, then full
       LLM-enriched results in background. Collapsed by default (just the bar). -->
  <aside id="reco-panel" class="reco-panel" aria-label="Artist recommendations"></aside>

  <footer class="site-footer">
    <div class="container">
      <p class="text-caption" style="font-size: 0.7rem;">2026 Resistor Technology &mdash; <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a> &middot; <a href="https://github.com/deeptechhouse/raiveFlier" target="_blank" rel="noopener">GitHub</a></p>
    </div>
  </footer>

  <!-- Application scripts — Loaded in dependency order at the end of <body>.
       Each module is an IIFE that attaches a single global object (e.g., App, Upload).
       Modules reference each other by checking `typeof ModuleName !== "undefined"`,
       which provides graceful degradation if a script fails to load.

       Load order matters:
         1. app.js            — Core SPA controller, must load first
         2. upload.js          — Depends on App (calls App.setSessionId, App.showView)
         3. confirmation.js    — Depends on App (calls App.getSessionId, App.showView)
         4. websocket.js       — Depends on App (calls App.showView, App.getSessionId)
         5. corpus.js          — Standalone, calls Rating.loadRatings if available
         6. rating.js          — Standalone utility, no dependencies
         7. qa.js              — Depends on Rating (optional)
         8. recommendations.js — Depends on Rating (optional)
         9. results.js         — Depends on App, QA, Rating, Recommendations (all optional)
  -->
  <script src="js/app.js"></script>
  <script src="js/upload.js"></script>
  <script src="js/confirmation.js"></script>
  <script src="js/websocket.js"></script>
  <script src="js/corpus.js"></script>
  <script src="js/rating.js"></script>
  <script src="js/qa.js"></script>
  <script src="js/recommendations.js"></script>
  <script src="js/results.js"></script>
</body>
</html>
